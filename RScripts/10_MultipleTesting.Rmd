---
title: "Testing covariates"
author: "Katharina Gerstner"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r opts, echo = FALSE}
knitr::opts_chunk$set(
  fig.width = 8
)
```

```{r, include=F}
.setwdntemp <- function(){
  cu <- Sys.info()["user"]
  cn <- Sys.info()["nodename"]
  
  if (cu == "rseppelt")
  {
    path2temp <- "/Users/rseppelt/Documents/Projekte/Synthese & Netzwerke/LU-BD-ES/Temp" 
    path2wd <- "/Users/rseppelt/Documents/git/LUBDES_MA/RScripts/" 
  } else if (cn == "UCBTTNE-LT"){
    path2wd <- "C:/Users/Tim/Documents/LUBDES_MA/RScripts/" #TN
    path2temp <- "C:/Users/Tim/Documents/LUBDES_MA_Out/" #TN
    
  } else if (cn == "juro-MacBookPro"){
    path2wd <- "/home/juro/git/LUBDES_MA/RScripts/" #MB
    path2temp <- "/home/juro/tmp/" #MB
  
  } else if (cn == "Helen-Phillipss-MacBook-Pro.local"){
    path2wd <- "/Users/Helen/LUBDES_MA/RScripts/"
    path2temp <- "/Users/Helen/tmp/" ##HP
  } else {
    path2wd <- "C:/Users/kg83hyby/Documents/GitHub/LUBDES_MA/RScripts/" #KG
    path2temp <- "C:/Users/kg83hyby/Documents/temp/" #KG 
  }  
  return(list(path2temp,path2wd))
}

set.list <-  .setwdntemp()
path2temp <- set.list[[1]]
path2wd <- set.list[[2]]

### helper function to combine strings
"%+%" <- function(x,y)paste(x,y,sep="")

source(path2wd %+% "01_load_libraries_and_functions.r")
load(file=path2temp %+% "SavedData.Rdata")
load(path2temp %+% "Models.Rdata")
library(multcomp)
```

We perform post-hoc pairwise comparisons after significant effects of covariates with three or more levels of a factor have been found (cf. Test of moderators $Q_M$ in Extended Data Table 5). We'd like to know which pairs of the factor levels are significantly different from each other.  

For the LUI model we use general liner hypothesis testing of type Tukeys' HSD test: 

```{r Testing  LUI}
summary(glht(Richness.MA.model[["LUI"]],linfct=cbind(contrMat(c("low-low"=1,"medium-medium"=1,"high-high"=1,"low-medium"=1,"low-high"=1,"medium-high"=1))), test=adjusted("holm")))
confint(glht(Richness.MA.model[["LUI"]],linfct=cbind(contrMat(c("low-low"=1,"medium-medium"=1,"high-high"=1,"low-medium"=1,"low-high"=1,"medium-high"=1),type="Tukey")), test=adjusted("holm")))

summary(glht(Yield.MA.model[["LUI"]],linfct=cbind(contrMat(c("low-low"=1,"medium-medium"=1,"high-high"=1,"low-medium"=1,"low-high"=1,"medium-high"=1),type="Tukey")), test=adjusted("holm")))
confint(glht(Yield.MA.model[["LUI"]],linfct=cbind(contrMat(c("low-low"=1,"medium-medium"=1,"high-high"=1,"low-medium"=1,"low-high"=1,"medium-high"=1),type="Tukey")), test=adjusted("holm")))

```

Within the full model we tested pairwise differences using pairwise t-tests with Holm-correction for multiple comparisons. We therefore predicted log-response ratios for all level combinations and tested differences in land-use history and main climate across levels of LUI, species groups, products and main_climate/land-use history. The notched boxplot are a graphical visualization where notches are used to compare groups: if the notches of two boxes do not overlap, this suggests that the medians are significantly different.  
```{r Testing history}
### Test for differences in Log RRs with land-use history
# for richness
model <- Richness.MA.model[["Full"]]

newdat <- expand.grid(LUI.range.level=levels(modelDataRichness$LUI.range.level),
                      Product = levels(modelDataRichness$Product),
                      Species.Group = levels(modelDataRichness$Species.Group),
                      landuse_history=levels(modelDataRichness$landuse_history),
                      main_climate=levels(modelDataRichness$main_climate)) 

mm <- model.matrix(~LUI.range.level + Product + Species.Group + landuse_history + main_climate + LUI.range.level:Product + LUI.range.level:Species.Group + LUI.range.level:landuse_history + LUI.range.level:main_climate + Species.Group:Product-1,data=newdat)
mm <- mm[,colnames(mm) %in% rownames(model$b)] # remove colums without coeffs
preds <- predict.rma(model, newmods = mm)
newdat[,c("logRR.richness","logRR.richness.se","logRR.richness.ci.lb","logRR.richness.ci.ub")] <- cbind(preds$pred,preds$se,preds$ci.lb,preds$ci.ub)
levels(newdat$landuse_history) <- c("5950 BC", "50 BC", "1450", "1950", "after 1950")

pairwise.t.test(newdat$logRR.richness,newdat$landuse_history,p.adjust.method="holm")

load(path2temp %+% "climate_mapdata.Rdata") #climate_zone

climate_mapdata <- fortify(climate_zone,region="main_climate")
climate_map <- ggplot() +
     geom_polygon(data = climate_mapdata, aes(x = long, y = lat, group = group,fill = id)) +
     scale_x_continuous(breaks=c(-90, 0, 90), labels=c("90°W", "0", "90°E")) +
     scale_y_continuous(breaks=c(-30, 0, 30, 60), labels=c("30°S","0°", "30°N","60°N"),limits=c(-55,90)) +
     xlab("") + ylab("") +
     scale_fill_manual(values=c('#2c7bb6','#abd9e9','#ffffbf','#fdae61','#d7191c'), 
                       name="",
                       limits=c("Polar","Cold (Continental)","Temperate","Arid","Tropical"), 
                       labels=c("Polar","Cold (Continental)","Temperate","Arid","Tropical")) + 
  theme_lubdes(legend.position="bottom",rel.text.size=1.2) +
#  guides(fill=guide_legend(nrow=2, byrow=T))+
  theme(legend.key = element_rect(colour = NA))

load(path2temp %+% "landuse_history_mapdata.Rdata")

LUhistory_data <- rasterToPoints(rmrsrkk11)
#Make the points a dataframe for ggplot
df <- data.frame(LUhistory_data)
#Make appropriate column headings
colnames(df) <- c("Longitude", "Latitude", "LUhistory")
df$LUhistory <- factor(df$LUhistory)
levels(df$LUhistory) <- c("5950 BC","50 BC", "1450","1950", "after 1950")

LUhistory_map <- ggplot(data=df, aes(y=Latitude, x=Longitude)) +
     geom_polygon(data = climate_mapdata, aes(x = long, y = lat, group = group, fill = NA)) +
     geom_raster(aes(fill=LUhistory)) + 
     scale_x_continuous(breaks=c(-90, 0, 90), labels=c("90°W", "0°", "90°E")) +
     scale_y_continuous(breaks=c(-30, 0, 30, 60), labels=c("30°S","0°", "30°N","60°N"),limits=c(-55,90)) +
     xlab("") + ylab("") +
     scale_fill_manual(values=c('#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026'), 
                       na.value="lightgrey",
                       name="",
                       limits=c("5950 BC","50 BC", "1450","1950", "after 1950")) + 
  theme_lubdes(legend.position="bottom",rel.text.size=1.2)


bp.hist.richness <- ggplot(newdat,aes(landuse_history,logRR.richness)) +
  geom_boxplot(aes(fill=landuse_history),notch=T) + 
  scale_x_discrete("",labels=NULL) +
  scale_fill_manual(values=c('#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026'), 
                    na.value="lightgrey",
                    name="",
                    limits=c("5950 BC","50 BC", "1450","1950", "after 1950")) +
  guides(fill="none") +
  ylab("Log(RR) for biodiversity") +
  theme_lubdes(rel.text.size=1.2) 

pairwise.t.test(newdat$logRR.richness,newdat$main_climate,p.adjust.method="holm")

bp.clim.richness <- ggplot(newdat,aes(main_climate,logRR.richness)) +
  geom_boxplot(aes(fill=main_climate),notch=T) + #Notches are used to compare groups; if the notches of two boxes do not overlap, this suggests that the medians are significantly different.
  scale_x_discrete("",labels=NULL) +
  scale_fill_manual(values=c('#2c7bb6','#abd9e9','#ffffbf','#fdae61','#d7191c'), 
                    name="",
                    limits=c("Polar","Cold (Continental)","Temperate","Arid","Tropical"), 
                    labels=c("Polar","Cold (Continental)","Temperate","Arid","Tropical")) + 
  guides(fill="none") +
  ylab("Log(RR) for biodiversity") +
  theme_lubdes(rel.text.size=1.2) 

# for yield
model <- Yield.MA.model[["Full"]]

newdat <- expand.grid(LUI.range.level=levels(modelDataYield$LUI.range.level),
                      Product = levels(modelDataYield$Product),
                      landuse_history=levels(modelDataYield$landuse_history),
                      main_climate=levels(modelDataYield$main_climate)) 

mm <- model.matrix(~LUI.range.level + Product + landuse_history + main_climate + LUI.range.level:Product + LUI.range.level:landuse_history + LUI.range.level:main_climate-1,data=newdat)
mm <- mm[,colnames(mm) %in% rownames(model$b)] # remove colums without coeffs
preds <- predict.rma(model, newmods = mm)
newdat[,c("logRR.Yield","logRR.Yield.se","logRR.Yield.ci.lb","logRR.Yield.ci.ub")] <- cbind(preds$pred,preds$se,preds$ci.lb,preds$ci.ub)
levels(newdat$landuse_history) <- c("5950 BC", "50 BC", "1450", "1950", "after 1950")

pairwise.t.test(newdat$logRR.Yield,newdat$landuse_history,p.adjust.method="holm")

bp.hist.yield <- ggplot(newdat,aes(landuse_history,logRR.Yield)) +
  geom_boxplot(aes(fill=landuse_history),notch=T) + 
  scale_x_discrete("",labels=NULL) +
  scale_fill_manual(values=c('#ffffb2','#fecc5c','#fd8d3c','#f03b20','#bd0026'), 
                    na.value="lightgrey",
                    name="",
                    limits=c("5950 BC","50 BC", "1450","1950", "after 1950")) +
  guides(fill="none") +
  ylab("Log(RR) for yield") +
  theme_lubdes(rel.text.size=1.2) 

pairwise.t.test(newdat$logRR.Yield,newdat$main_climate,p.adjust.method="holm")

bp.clim.yield <- ggplot(newdat,aes(main_climate,logRR.Yield)) +
  geom_boxplot(aes(fill=main_climate),notch=T) + #Notches are used to compare groups; if the notches of two boxes do not overlap, this suggests that the medians are significantly different.
  scale_x_discrete("",labels=NULL) +
  scale_fill_manual(values=c('#2c7bb6','#abd9e9','#ffffbf','#fdae61','#d7191c'), 
                    name="",
                    limits=c("Polar","Cold (Continental)","Temperate","Arid","Tropical"), 
                    labels=c("Polar","Cold (Continental)","Temperate","Arid","Tropical")) + 
  guides(fill="none") +
  ylab("Log(RR) for yield") +
  theme_lubdes(rel.text.size=1.2) 

lay <- rbind(c(1,1), c(2,3))

bp.hist <- grid.arrange(LUhistory_map,bp.hist.richness, bp.hist.yield,ncol=2, nrow=2,layout_matrix=lay)
bp.clim <- grid.arrange(climate_map,bp.clim.richness, bp.clim.yield,ncol=2, nrow=2,layout_matrix=lay)

ggsave(bp.hist,file=path2temp %+% "bphist.png", width=10,height=12)
ggsave(bp.clim,file=path2temp %+% "bpclim.png", width=10,height=12)

```

```{r confounding variables}
ES.frame.richness <- rename.factor.levels(ES.frame.richness)
ES.frame.yield <- rename.factor.levels(ES.frame.yield)
### Are BD and ES measured from the same species (e.g. weed BD and weed biomass in grasslands is linked)?
sub <- subset(ES.frame.richness,Species.Group=="Plants")
p1 <- ggplot(data=sub,aes(y=Log.RR,x=factor(ES.and.BD))) + 
  geom_boxplot() +
  theme(axis.text = element_text(size = rel(1.2)), 
        axis.ticks = element_line(colour = "black"), 
        axis.title = element_text(size = rel(1.2))) +
  theme_lubdes(legend.position="bottom",rel.text.size=1.8) +
  xlab("Biodiversity and yield") +
  scale_x_discrete(labels=c("Independent","Linked")) +
  ylab("Log(RR) for biodiversity")

t.test(Log.RR ~ factor(ES.and.BD), data=sub)


### Is land use intensity measured from data on yield.
sub.ES <- subset(ES.frame.yield,Product %in% c("Wood","Green fodder"))
p2 <- ggplot(data=sub.ES,aes(y=Log.RR,x=factor(LU.definition.and.ES))) + 
  geom_boxplot()+
  theme(axis.text = element_text(size = rel(1.2)), 
        axis.ticks = element_line(colour = "black"), 
        axis.title = element_text(size = rel(1.2))) +
  xlab("Land-use intensity and yield") + 
  ylab("Log(RR) for yield") + 
  theme_lubdes(legend.position="bottom",rel.text.size=1.8) +
  scale_x_discrete(labels=c("Independent","Linked")) +
  facet_grid(.~Product)

t.test(Log.RR ~ factor(LU.definition.and.ES), data=subset(ES.frame.yield,Product=="Wood"))
t.test(Log.RR ~ factor(LU.definition.and.ES), data=subset(ES.frame.yield,Product=="Green fodder"))

p12 <- grid.arrange(p1, p2,ncol=2, nrow=1,widths=c(1.4,3))
ggsave(p12,file=path2temp %+% "confoundingVariable1.png", width=9,height=4)

### Relationship spatial scale - log.RR

hist(log(ES.frame.richness$Richness.Plot.Size))

# fit linear model
fm <- lm(Log.RR ~ log(Richness.Plot.Size), data=ES.frame.richness)

summary(fm)

# plot data and fitted line
p3 <- ggplot(data=ES.frame.richness,aes(y=Log.RR,x=log(Richness.Plot.Size))) + 
  geom_point(size=2,alpha=0.5) + 
  stat_smooth(method=lm,se=F,color="black") +
  theme(axis.text = element_text(size = rel(1.2)), 
        axis.ticks = element_line(colour = "black"), 
        axis.title = element_text(size = rel(1.2)))+
  theme_lubdes(legend.position="bottom",rel.text.size=1.8) +
  ylab("Log(RR) for biodiversity") +
  xlab("Log(spatial grain)")

### Relationship Yield.Unit.Type - log.RR
# fm2 <- aov(Log.RR ~ Yield.Unit.Type, data=ES.frame.yield)
# TukeyHSD(fm2)
# plot(TukeyHSD(fm2),las=1)
pairwise.t.test(ES.frame.yield$Log.RR,ES.frame.yield$Yield.Unit.Type,p.adjust.method="holm")

p4 <- ggplot(data=ES.frame.yield,aes(y=Log.RR,x=factor(Yield.Unit.Type))) +
  geom_boxplot(notch=T)+
  theme(axis.text = element_text(size = rel(1.2)), 
        axis.ticks = element_line(colour = "black"), 
        axis.title = element_text(size = rel(1.2))) + 
  scale_x_discrete("Yield unit",labels=c("Area/area","Mass/area", "Count/area", "Others")) +
  theme_lubdes(legend.position="bottom",rel.text.size=1.8) +
  ylab("Log(RR) for yield") +
  xlab("")

p.grid <- grid.arrange(p1,p2,p3, p4,ncol=2, nrow=2,widths=c(1,1))
ggsave(p.grid,file=path2temp %+% "confoundingVariables.png", width=14,height=14)
```



